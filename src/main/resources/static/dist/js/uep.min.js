/*admin-lte-2.4.2@2018-04-22*/
function logout() {}

function create_const_select(a, b) {
    var c = $(b), d = c.attr("data-constVal"), e = Const.getListByGroup(a);
    $.each(e, function(a, b) {
        1 == b.activeFlag && c.append($("<option value='" + b.constCode + "' " + (d == b.constCode ? "selected" : "") + ">" + b.constName + "</option>"));
    });
}

function queryEvent() {
    var a = {
        ajax: {
            url: "/event/list",
            method: "POST",
            contentType: "application/json;charset=UTF-8",
            dataSrc: function(a) {
                return a.data.forEach(function(a) {
                    a.genderStr = a.gender, a.genderStr = Const.translateByGroupAndCode("GENDER", a.gender), 
                    a.eventTypeStr = Const.translateByGroupAndCode("EVENT_TYPE", a.eventType), a.signed || (a.eventTypeStr += '<small class="badge bg-yellow newflag">新</small>'), 
                    a.name = '<a href="/event/' + a.eventId + '" target=_blank>' + a.name + "</a>";
                }), a.data;
            },
            data: function(a) {
                return a.condition = $("#eventQueryForm").serializeObject(), a.condition.eventType = currentMenu, 
                JSON.stringify(a);
            }
        },
        rowCallback: function(a, b, c) {
            $(a).addClass("newmessage").on("click", function() {
                window.open("/event/" + b.eventId);
            });
        },
        columns: [ {
            data: "eventTypeStr"
        }, {
            data: "name"
        }, {
            data: "genderStr"
        }, {
            data: "idNum"
        }, {
            data: "eventTime"
        }, {
            data: "inputTime"
        }, {
            data: "inputRealName"
        }, {
            data: "inputOrgName"
        } ]
    };
    $("#eventTable").DataTable().destroy(), $("#eventTable").dataTable($.extend({}, a, tableDefaultOptions));
}

function _guessPageFromLocation() {
    var a = location.search.indexOf("t="), b = location.search.substr(a + 2);
    a = b.indexOf("&"), a > -1 && (b = b.substr(0, a)), "0" == (currentMenu = b) && (currentMenu = "");
}

function _showPageTitle() {
    var a = '<span class="glyphicon glyphicon-bell"></span> 您有<a data-toggle="tooltip" onclick="loadNewMessage();" title="点击显示所有未签收消息" id="newCount" class="badge bg-red" data-original-title="点击显示所有未签收消息">0</a>条新消息';
    "" != currentMenu && (a = Const.translateByGroupAndCode("EVENT_TYPE", currentMenu)), 
    $(".list-title").html(a), $('[data-toggle="tooltip"]').tooltip();
}

function loadNewMessage() {
    currentMenu = "NEW", $("#eventQueryForm").get(0).reset(), queryEvent();
}

function _loadNewMessageCount() {
    0 != $("#newCount").length && $.get("/event/newcount", function(a) {
        a.success && $("#newCount").text(a.data);
    });
}

function insertAttach(a) {
    $(a).before($("<input type=file name=file>"));
}

$.fn.serializeObject = function() {
    var a = {}, b = this.serializeArray();
    return $.each(b, function() {
        void 0 !== a[this.name] ? (a[this.name].push || (a[this.name] = [ a[this.name] ]), 
        a[this.name].push(this.value || "")) : a[this.name] = this.value || "";
    }), a;
};

var datepickerConfig = {
    locale: {
        format: "YYYY-MM-DD",
        separator: " 至 ",
        applyLabel: "确定",
        cancelLabel: "取消",
        fromLabel: "从",
        toLabel: "至",
        daysOfWeek: [ "日", "一", "二", "三", "四", "五", "六" ],
        monthNames: [ "一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月" ],
        firstDay: 1
    },
    autoApply: !0,
    showDropdowns: !0
};

$(function() {
    $.ajaxSetup({
        beforeSend: function(a) {
            var b = $("meta[name='_csrf']").attr("content"), c = $("meta[name='_csrf_header']").attr("content");
            b && c && a.setRequestHeader(c, b);
        }
    }), $(":radio,:checkbox").iCheck({
        checkboxClass: "icheckbox_square-blue",
        radioClass: "iradio_flat-blue"
    }).on("ifChanged", function(a) {
        $(a.target).trigger("change");
    }), $("[data-datepicker]").daterangepicker($.extend({}, datepickerConfig, {
        singleDatePicker: !0
    })), $("[data-daterangepicker]").daterangepicker(datepickerConfig), $("[data-daterangepicker]").each(function(a, b) {
        var c = $(b).attr("data-default");
        $(b).val(c);
    }), $('[data-toggle="tooltip"]').tooltip();
});

var Const = {
    cacheAllConst: function() {
        $.ajax("/const", {
            async: !1
        }).done(function(a) {
            sessionStorage.setItem("consts", JSON.stringify(a));
        });
    },
    getListByGroup: function(a) {
        var b = JSON.parse(sessionStorage.getItem("consts")), c = [];
        return b.forEach(function(b) {
            b.constGroup == a && c.push(b);
        }), c;
    },
    translateByGroupAndCode: function(a, b) {
        var c = JSON.parse(sessionStorage.getItem("consts")), d = {
            constName: "",
            constCode: ""
        };
        return c.forEach(function(c) {
            c.constGroup == a && c.constCode == b && (d = c);
        }), d.constName;
    }
};

$(function() {
    Const.cacheAllConst(), $("select[data-constGroup]").each(function(a, b) {
        create_const_select($(b).attr("data-constGroup"), b);
    }), $("label[data-const],span[data-const],p[data-const]").each(function(a, b) {
        b = $(b);
        var c = Const.translateByGroupAndCode(b.attr("data-constgroup"), b.attr("data-constval"));
        b.text(c);
    });
});

var currentMenu = "", tableDefaultOptions = {
    paging: !0,
    processing: !0,
    serverSide: !0,
    pageLength: 20,
    lengthChange: !1,
    searching: !1,
    ordering: !1,
    info: !0,
    autoWidth: !1,
    language: {
        lengthMenu: "每页显示 _MENU_ 行",
        zeroRecords: "未检索到数据，请去掉部分检索条件后重试，或检索其他类型。",
        info: "第 _PAGE_ 页/共 _PAGES_ 页（显示第 _START_ ~ _END_条 / 共检索出 _MAX_ 条）",
        infoEmpty: "未检索到数据",
        infoFiltered: "(从 _MAX_ 条记录中筛选)",
        loadingRecords: "加载中...",
        loading: "正在搜索...",
        processing: "正在搜索...",
        paginate: {
            first: "第一页",
            last: "最后一页",
            next: "下一页",
            previous: "上一页"
        }
    }
};

$(function() {
    _guessPageFromLocation(), _showPageTitle(), _loadNewMessageCount(), $(".navbar-nav li").each(function(a, b) {
        $(b).attr("data-eventType") == currentMenu ? $(b).addClass("active") : $(b).removeClass("active");
    }), queryEvent();
});